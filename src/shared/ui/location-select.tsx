'use client';

import * as React from 'react';
import { Check } from 'lucide-react';

import { cn } from '@/lib/utils';
import {
  Command,
  CommandEmpty,
  CommandGroup,
  CommandInput,
  CommandItem,
  CommandList,
} from '@/components/ui/command';
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
} from '@/components/ui/dialog';

interface Location {
  code: string;
  name: string;
  region: string;
}

interface LocationSelectProps {
  value?: string;
  onChange: (value: string) => void;
  placeholder?: string;
  disabled?: boolean;
  className?: string;
  error?: boolean;
  showFullName?: boolean;
}

// Классификатор районов и городов Республики Узбекистан (СОАТО)
const LOCATIONS: Location[] = [
  // Республика Каракалпакстан
  { code: '1735', name: 'г. Нукус', region: 'Республика Каракалпакстан' },
  { code: '1735201', name: 'Амударьинский район', region: 'Республика Каракалпакстан' },
  { code: '1735204', name: 'Берунийский район', region: 'Республика Каракалпакстан' },
  { code: '1735207', name: 'Кегейлийский район', region: 'Республика Каракалпакстан' },
  { code: '1735210', name: 'Канлыкольский район', region: 'Республика Каракалпакстан' },
  { code: '1735212', name: 'Караузякский район', region: 'Республика Каракалпакстан' },
  { code: '1735214', name: 'Кунградский район', region: 'Республика Каракалпакстан' },
  { code: '1735217', name: 'Муйнакский район', region: 'Республика Каракалпакстан' },
  { code: '1735220', name: 'Нукусский район', region: 'Республика Каракалпакстан' },
  { code: '1735224', name: 'Тахтакупырский район', region: 'Республика Каракалпакстан' },
  { code: '1735227', name: 'Турткульский район', region: 'Республика Каракалпакстан' },
  { code: '1735230', name: 'Ходжейлийский район', region: 'Республика Каракалпакстан' },
  { code: '1735233', name: 'Чимбайский район', region: 'Республика Каракалпакстан' },
  { code: '1735236', name: 'Шуманайский район', region: 'Республика Каракалпакстан' },
  { code: '1735238', name: 'Элликкалинский район', region: 'Республика Каракалпакстан' },
  
  // Андижанская область
  { code: '1703', name: 'г. Андижан', region: 'Андижанская область' },
  { code: '1703401', name: 'Андижанский район', region: 'Андижанская область' },
  { code: '1703403', name: 'Асакинский район', region: 'Андижанская область' },
  { code: '1703406', name: 'Балыкчинский район', region: 'Андижанская область' },
  { code: '1703410', name: 'Бозский район', region: 'Андижанская область' },
  { code: '1703412', name: 'Булакбашинский район', region: 'Андижанская область' },
  { code: '1703415', name: 'Джалакудукский район', region: 'Андижанская область' },
  { code: '1703418', name: 'Избосканский район', region: 'Андижанская область' },
  { code: '1703424', name: 'Кургантепинский район', region: 'Андижанская область' },
  { code: '1703427', name: 'Мархаматский район', region: 'Андижанская область' },
  { code: '1703432', name: 'Пахтаабадский район', region: 'Андижанская область' },
  { code: '1703434', name: 'Улугнорский район', region: 'Андижанская область' },
  { code: '1703436', name: 'Ходжаабадский район', region: 'Андижанская область' },
  { code: '1703440', name: 'Шахриханский район', region: 'Андижанская область' },
  
  // Бухарская область
  { code: '1706', name: 'г. Бухара', region: 'Бухарская область' },
  { code: '1706401', name: 'Алатский район', region: 'Бухарская область' },
  { code: '1706404', name: 'Бухарский район', region: 'Бухарская область' },
  { code: '1706407', name: 'Вабкентский район', region: 'Бухарская область' },
  { code: '1706410', name: 'Гиждуванский район', region: 'Бухарская область' },
  { code: '1706412', name: 'Жондорский район', region: 'Бухарская область' },
  { code: '1706415', name: 'Каганский район', region: 'Бухарская область' },
  { code: '1706418', name: 'Каракульский район', region: 'Бухарская область' },
  { code: '1706420', name: 'Пешкунский район', region: 'Бухарская область' },
  { code: '1706424', name: 'Ромитанский район', region: 'Бухарская область' },
  { code: '1706427', name: 'Шафирканский район', region: 'Бухарская область' },
  
  // Джизакская область
  { code: '1708', name: 'г. Джизак', region: 'Джизакская область' },
  { code: '1708401', name: 'Арнасайский район', region: 'Джизакская область' },
  { code: '1708404', name: 'Бахмальский район', region: 'Джизакская область' },
  { code: '1708406', name: 'Галляаральский район', region: 'Джизакская область' },
  { code: '1708410', name: 'Джизакский район', region: 'Джизакская область' },
  { code: '1708412', name: 'Дустликский район', region: 'Джизакская область' },
  { code: '1708415', name: 'Зааминский район', region: 'Джизакская область' },
  { code: '1708418', name: 'Зарбдорский район', region: 'Джизакская область' },
  { code: '1708420', name: 'Мирзачульский район', region: 'Джизакская область' },
  { code: '1708424', name: 'Пахтакорский район', region: 'Джизакская область' },
  { code: '1708427', name: 'Фаришский район', region: 'Джизакская область' },
  { code: '1708430', name: 'Янгиабадский район', region: 'Джизакская область' },
  
  // Кашкадарьинская область
  { code: '1710', name: 'г. Карши', region: 'Кашкадарьинская область' },
  { code: '1710401', name: 'Гузарский район', region: 'Кашкадарьинская область' },
  { code: '1710403', name: 'Дехканабадский район', region: 'Кашкадарьинская область' },
  { code: '1710406', name: 'Камашинский район', region: 'Кашкадарьинская область' },
  { code: '1710410', name: 'Каршинский район', region: 'Кашкадарьинская область' },
  { code: '1710412', name: 'Касанский район', region: 'Кашкадарьинская область' },
  { code: '1710415', name: 'Касбинский район', region: 'Кашкадарьинская область' },
  { code: '1710418', name: 'Китабский район', region: 'Кашкадарьинская область' },
  { code: '1710420', name: 'Миришкорский район', region: 'Кашкадарьинская область' },
  { code: '1710424', name: 'Мубарекский район', region: 'Кашкадарьинская область' },
  { code: '1710427', name: 'Нишанский район', region: 'Кашкадарьинская область' },
  { code: '1710430', name: 'Чиракчинский район', region: 'Кашкадарьинская область' },
  { code: '1710433', name: 'Шахрисабзский район', region: 'Кашкадарьинская область' },
  { code: '1710436', name: 'Яккабагский район', region: 'Кашкадарьинская область' },
  
  // Навоийская область
  { code: '1712', name: 'г. Навои', region: 'Навоийская область' },
  { code: '1712401', name: 'Канимехский район', region: 'Навоийская область' },
  { code: '1712403', name: 'Кызылтепинский район', region: 'Навоийская область' },
  { code: '1712406', name: 'Навбахорский район', region: 'Навоийская область' },
  { code: '1712410', name: 'Нуратинский район', region: 'Навоийская область' },
  { code: '1712412', name: 'Тамдынский район', region: 'Навоийская область' },
  { code: '1712415', name: 'Учкудукский район', region: 'Навоийская область' },
  { code: '1712418', name: 'Хатырчинский район', region: 'Навоийская область' },
  { code: '1712420', name: 'г. Зарафшан', region: 'Навоийская область' },
  
  // Наманганская область
  { code: '1714', name: 'г. Наманган', region: 'Наманганская область' },
  { code: '1714401', name: 'Касансайский район', region: 'Наманганская область' },
  { code: '1714403', name: 'Мингбулакский район', region: 'Наманганская область' },
  { code: '1714406', name: 'Наманганский район', region: 'Наманганская область' },
  { code: '1714410', name: 'Нарынский район', region: 'Наманганская область' },
  { code: '1714412', name: 'Папский район', region: 'Наманганская область' },
  { code: '1714415', name: 'Туракурганский район', region: 'Наманганская область' },
  { code: '1714418', name: 'Уйчинский район', region: 'Наманганская область' },
  { code: '1714420', name: 'Учкурганский район', region: 'Наманганская область' },
  { code: '1714424', name: 'Чартакский район', region: 'Наманганская область' },
  { code: '1714427', name: 'Чустский район', region: 'Наманганская область' },
  { code: '1714430', name: 'Янгикурганский район', region: 'Наманганская область' },
  
  // Самаркандская область
  { code: '1718', name: 'г. Самарканд', region: 'Самаркандская область' },
  { code: '1718401', name: 'Акдарьинский район', region: 'Самаркандская область' },
  { code: '1718403', name: 'Булунгурский район', region: 'Самаркандская область' },
  { code: '1718406', name: 'Джамбайский район', region: 'Самаркандская область' },
  { code: '1718410', name: 'Иштыханский район', region: 'Самаркандская область' },
  { code: '1718412', name: 'Каттакурганский район', region: 'Самаркандская область' },
  { code: '1718415', name: 'Кошрабадский район', region: 'Самаркандская область' },
  { code: '1718418', name: 'Нарпайский район', region: 'Самаркандская область' },
  { code: '1718420', name: 'Нуробадский район', region: 'Самаркандская область' },
  { code: '1718424', name: 'Пайарыкский район', region: 'Самаркандская область' },
  { code: '1718427', name: 'Пастдаргомский район', region: 'Самаркандская область' },
  { code: '1718430', name: 'Пахтачийский район', region: 'Самаркандская область' },
  { code: '1718433', name: 'Самаркандский район', region: 'Самаркандская область' },
  { code: '1718436', name: 'Тайлакский район', region: 'Самаркандская область' },
  { code: '1718440', name: 'Ургутский район', region: 'Самаркандская область' },
  { code: '1718442', name: 'г. Каттакурган', region: 'Самаркандская область' },
  
  // Сурхандарьинская область
  { code: '1722', name: 'г. Термез', region: 'Сурхандарьинская область' },
  { code: '1722401', name: 'Алтынсайский район', region: 'Сурхандарьинская область' },
  { code: '1722403', name: 'Ангорский район', region: 'Сурхандарьинская область' },
  { code: '1722406', name: 'Байсунский район', region: 'Сурхандарьинская область' },
  { code: '1722410', name: 'Бандиханский район', region: 'Сурхандарьинская область' },
  { code: '1722412', name: 'Денауский район', region: 'Сурхандарьинская область' },
  { code: '1722415', name: 'Джаркурганский район', region: 'Сурхандарьинская область' },
  { code: '1722418', name: 'Кизирикский район', region: 'Сурхандарьинская область' },
  { code: '1722420', name: 'Кумкурганский район', region: 'Сурхандарьинская область' },
  { code: '1722424', name: 'Музрабадский район', region: 'Сурхандарьинская область' },
  { code: '1722427', name: 'Сариасийский район', region: 'Сурхандарьинская область' },
  { code: '1722430', name: 'Термезский район', region: 'Сурхандарьинская область' },
  { code: '1722433', name: 'Узунский район', region: 'Сурхандарьинская область' },
  { code: '1722436', name: 'Шерабадский район', region: 'Сурхандарьинская область' },
  { code: '1722440', name: 'Шурчинский район', region: 'Сурхандарьинская область' },
  
  // Сырдарьинская область
  { code: '1724', name: 'г. Гулистан', region: 'Сырдарьинская область' },
  { code: '1724401', name: 'Акалтынский район', region: 'Сырдарьинская область' },
  { code: '1724403', name: 'Баяутский район', region: 'Сырдарьинская область' },
  { code: '1724406', name: 'Гулистанский район', region: 'Сырдарьинская область' },
  { code: '1724410', name: 'Мирзаабадский район', region: 'Сырдарьинская область' },
  { code: '1724412', name: 'Сайхунабадский район', region: 'Сырдарьинская область' },
  { code: '1724415', name: 'Сардобинский район', region: 'Сырдарьинская область' },
  { code: '1724418', name: 'Сырдарьинский район', region: 'Сырдарьинская область' },
  { code: '1724420', name: 'Хавастский район', region: 'Сырдарьинская область' },
  { code: '1724424', name: 'г. Ширин', region: 'Сырдарьинская область' },
  { code: '1724427', name: 'г. Янгиер', region: 'Сырдарьинская область' },
  
  // Ташкентская область
  { code: '1727', name: 'г. Нурафшан', region: 'Ташкентская область' },
  { code: '1727401', name: 'Аккурганский район', region: 'Ташкентская область' },
  { code: '1727403', name: 'Ахангаранский район', region: 'Ташкентская область' },
  { code: '1727406', name: 'Бекабадский район', region: 'Ташкентская область' },
  { code: '1727410', name: 'Бостанлыкский район', region: 'Ташкентская область' },
  { code: '1727412', name: 'Букинский район', region: 'Ташкентская область' },
  { code: '1727415', name: 'Зангиатинский район', region: 'Ташкентская область' },
  { code: '1727418', name: 'Кибрайский район', region: 'Ташкентская область' },
  { code: '1727420', name: 'Куйичирчикский район', region: 'Ташкентская область' },
  { code: '1727424', name: 'Паркентский район', region: 'Ташкентская область' },
  { code: '1727427', name: 'Пскентский район', region: 'Ташкентская область' },
  { code: '1727430', name: 'Ташкентский район', region: 'Ташкентская область' },
  { code: '1727433', name: 'Уртачирчикский район', region: 'Ташкентская область' },
  { code: '1727436', name: 'Чиназский район', region: 'Ташкентская область' },
  { code: '1727440', name: 'Юкоричирчикский район', region: 'Ташкентская область' },
  { code: '1727442', name: 'Янгиюльский район', region: 'Ташкентская область' },
  { code: '1727444', name: 'г. Алмалык', region: 'Ташкентская область' },
  { code: '1727446', name: 'г. Ангрен', region: 'Ташкентская область' },
  { code: '1727448', name: 'г. Бекабад', region: 'Ташкентская область' },
  { code: '1727450', name: 'г. Чирчик', region: 'Ташкентская область' },
  { code: '1727452', name: 'г. Янгиюль', region: 'Ташкентская область' },
  
  // Ферганская область
  { code: '1730', name: 'г. Фергана', region: 'Ферганская область' },
  { code: '1730401', name: 'Алтыарыкский район', region: 'Ферганская область' },
  { code: '1730403', name: 'Багдадский район', region: 'Ферганская область' },
  { code: '1730406', name: 'Бешарыкский район', region: 'Ферганская область' },
  { code: '1730410', name: 'Бувайдинский район', region: 'Ферганская область' },
  { code: '1730412', name: 'Дангаринский район', region: 'Ферганская область' },
  { code: '1730415', name: 'Кувинский район', region: 'Ферганская область' },
  { code: '1730418', name: 'Риштанский район', region: 'Ферганская область' },
  { code: '1730420', name: 'Сохский район', region: 'Ферганская область' },
  { code: '1730424', name: 'Ташлакский район', region: 'Ферганская область' },
  { code: '1730427', name: 'Узбекистанский район', region: 'Ферганская область' },
  { code: '1730430', name: 'Учкуприкский район', region: 'Ферганская область' },
  { code: '1730433', name: 'Ферганский район', region: 'Ферганская область' },
  { code: '1730436', name: 'Фуркатский район', region: 'Ферганская область' },
  { code: '1730440', name: 'Язъяванский район', region: 'Ферганская область' },
  { code: '1730442', name: 'г. Коканд', region: 'Ферганская область' },
  { code: '1730444', name: 'г. Кувасай', region: 'Ферганская область' },
  { code: '1730446', name: 'г. Маргилан', region: 'Ферганская область' },
  
  // Хорезмская область
  { code: '1733', name: 'г. Ургенч', region: 'Хорезмская область' },
  { code: '1733401', name: 'Багатский район', region: 'Хорезмская область' },
  { code: '1733403', name: 'Гурленский район', region: 'Хорезмская область' },
  { code: '1733406', name: 'Кошкупырский район', region: 'Хорезмская область' },
  { code: '1733410', name: 'Ургенчский район', region: 'Хорезмская область' },
  { code: '1733412', name: 'Хазараспский район', region: 'Хорезмская область' },
  { code: '1733415', name: 'Ханкинский район', region: 'Хорезмская область' },
  { code: '1733418', name: 'Хивинский район', region: 'Хорезмская область' },
  { code: '1733420', name: 'Шаватский район', region: 'Хорезмская область' },
  { code: '1733424', name: 'Янгиарыкский район', region: 'Хорезмская область' },
  { code: '1733426', name: 'Янгибазарский район', region: 'Хорезмская область' },
  
  // г. Ташкент
  { code: '1726', name: 'г. Ташкент', region: 'г. Ташкент' },
  { code: '1726201', name: 'Алмазарский район', region: 'г. Ташкент' },
  { code: '1726204', name: 'Бектемирский район', region: 'г. Ташкент' },
  { code: '1726207', name: 'Мирабадский район', region: 'г. Ташкент' },
  { code: '1726210', name: 'Мирзо-Улугбекский район', region: 'г. Ташкент' },
  { code: '1726213', name: 'Сергелийский район', region: 'г. Ташкент' },
  { code: '1726216', name: 'Учтепинский район', region: 'г. Ташкент' },
  { code: '1726219', name: 'Чиланзарский район', region: 'г. Ташкент' },
  { code: '1726222', name: 'Шайхантахурский район', region: 'г. Ташкент' },
  { code: '1726225', name: 'Юнусабадский район', region: 'г. Ташкент' },
  { code: '1726228', name: 'Яккасарайский район', region: 'г. Ташкент' },
  { code: '1726231', name: 'Яшнабадский район', region: 'г. Ташкент' },
];

// Группируем по регионам
const REGIONS = [
  'г. Ташкент',
  'Ташкентская область',
  'Андижанская область',
  'Бухарская область',
  'Джизакская область',
  'Кашкадарьинская область',
  'Навоийская область',
  'Наманганская область',
  'Самаркандская область',
  'Сурхандарьинская область',
  'Сырдарьинская область',
  'Ферганская область',
  'Хорезмская область',
  'Республика Каракалпакстан',
];

export function LocationSelect({
  value,
  onChange,
  placeholder = 'Выберите местоположение',
  disabled = false,
  className,
  error,
  showFullName = false,
}: LocationSelectProps) {
  const [open, setOpen] = React.useState(false);

  const selectedLocation = React.useMemo(
    () => LOCATIONS.find((l) => l.code === value),
    [value]
  );

  const getDisplayValue = () => {
    if (!selectedLocation) {
      return placeholder;
    }
    
    if (showFullName) {
      return `${selectedLocation.code} - ${selectedLocation.name}`;
    }
    
    return selectedLocation.code;
  };

  // Группируем локации по регионам
  const groupedLocations = React.useMemo(() => {
    const groups = new Map<string, Location[]>();
    REGIONS.forEach(region => {
      const regionLocations = LOCATIONS.filter(l => l.region === region);
      if (regionLocations.length > 0) {
        groups.set(region, regionLocations);
      }
    });
    return groups;
  }, []);

  return (
    <>
      {/* Текст-триггер */}
      <button
        type="button"
        onClick={() => !disabled && setOpen(true)}
        disabled={disabled}
        className={cn(
          'hover:underline cursor-pointer font-medium text-left truncate',
          selectedLocation && showFullName ? 'text-black hover:text-gray-700' : 'text-green-600 hover:text-green-700',
          disabled && 'opacity-50 cursor-not-allowed',
          error && 'text-red-500',
          !value && 'text-green-400',
          className
        )}
      >
        {getDisplayValue()}
      </button>

      {/* Модальное окно для выбора */}
      <Dialog open={open} onOpenChange={setOpen}>
        <DialogContent className="sm:max-w-[550px] max-h-[80vh]">
          <DialogHeader>
            <DialogTitle>Выберите местоположение товаров</DialogTitle>
          </DialogHeader>
          <Command className="border rounded-lg">
            <CommandInput placeholder="Поиск по коду или названию..." />
            <CommandList className="max-h-[400px]">
              <CommandEmpty>Местоположение не найдено</CommandEmpty>
              {Array.from(groupedLocations.entries()).map(([region, locations]) => (
                <CommandGroup key={region} heading={region}>
                  {locations.map((location) => (
                    <CommandItem
                      key={location.code}
                      value={`${location.code} ${location.name} ${location.region}`}
                      onSelect={() => {
                        onChange(location.code);
                        setOpen(false);
                      }}
                      className="cursor-pointer"
                    >
                      <Check
                        className={cn(
                          'mr-2 h-4 w-4',
                          value === location.code ? 'opacity-100' : 'opacity-0'
                        )}
                      />
                      <div className="flex items-center gap-2">
                        <span className="font-mono text-xs font-bold text-primary">
                          {location.code}
                        </span>
                        <span className="truncate text-sm">{location.name}</span>
                      </div>
                    </CommandItem>
                  ))}
                </CommandGroup>
              ))}
            </CommandList>
          </Command>
        </DialogContent>
      </Dialog>
    </>
  );
}

// Экспорт списка локаций для использования в других компонентах
export { LOCATIONS };
